"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _child_process=require("child_process");var _events=require("events");var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var log=require('npmlog');var Packager=function(){function Packager(){_classCallCheck(this,Packager);this.fructosePackager=null;this.events=new _events2.default();this.dead=false;}_createClass(Packager,[{key:"packagerStarted",value:function packagerStarted(){var _this=this;console.log(7);return new Promise(function(resolve){_this.events.on('started',resolve);});}},{key:"checkPackager",value:function checkPackager(){if(this.fructosePackager===null){throw Error("Packager is null");}}},{key:"start",value:function start(){var _this2=this;return regeneratorRuntime.async(function start$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log(6);log.verbose("starting packager");this.events.on("exit",function(){_this2.dead=true;});this.fructosePackager=(0,_child_process.spawn)("npm",["run","fructose-app"],{cwd:getCwd()});this.handlePackager();_context.next=7;return regeneratorRuntime.awrap(this.packagerStarted());case 7:case"end":return _context.stop();}}},null,this);}},{key:"kill",value:function kill(){var _this3=this;return regeneratorRuntime.async(function kill$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.checkPackager();new Promise(function(resolve){if(_this3.dead===true){resolve();}else{console.log('killing packager');log.verbose('killing packager');_this3.fructosePackager.kill('SIGINT');resolve();}});case 2:case"end":return _context2.stop();}}},null,this);}},{key:"handlePackager",value:function handlePackager(){var _this4=this;this.fructosePackager.stdout.on("data",function(d){console.log(d.toString('utf8'));log.verbose(d.toString("utf8"));if(d.toString("utf8").includes("Loading dependency graph, done.")){_this4.events.emit('started');}});this.fructosePackager.stderr.on("data",function(d){log.error(d.toString("utf8"));});this.fructosePackager.on("close",function(code){if(code===11){log.error('Packager could not listen on port 8081');_this4.events.emit("exit");}else if(code!==0){log.error("packager did not exit correctly: code "+code);_this4.events.emit("exit");}});}}]);return Packager;}();exports.default=Packager;var getCwd=function getCwd(){var forwardSlashesAfterRoot=process.cwd().substr(process.cwd().indexOf("e2eTests")).match(/\//g);var numForwardSlashes=forwardSlashesAfterRoot?forwardSlashesAfterRoot.length:0;var cwd=process.cwd();for(var i=0;i<numForwardSlashes;i+=1){cwd+="/..";}return cwd;};
